I"’#<p>javacript æ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ï¼Œå› æ­¤åœ¨æ‰§è¡Œä¸€äº›ç½‘ç»œæ“ä½œï¼Œæµè§ˆå™¨äº‹ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¿…é¡»é‡‡ç”¨å¼‚æ­¥çš„æ–¹å¼ã€‚å¼‚æ­¥å‡½æ•°å¯ä»¥ç”±å›è°ƒå‡½æ•°å®ç°ï¼š</p>

<pre><code class="language-js">function cb () {
  console.log('this is cb');
}
setTimeout(cb, 100);
console.log('this is main thread')
</code></pre>

<p>é¦–å…ˆä¼šå…ˆè¾“å‡ºï¼šthis is main thread, å…¶æ¬¡åœ¨ç»è¿‡100msä¹‹åè¾“å‡ºï¼š this is cb</p>

<p>åœ¨æˆ‘ä»¬çš„æ—¥å¸¸å¼€å‘ä¸­è¿‡åº¦ä¾èµ–å›è°ƒå‡½æ•°ä¼šå¸¦æ¥ä»€ä¹ˆå½±å“å‘¢ï¼Ÿ</p>

<ol>
  <li>æˆ‘ä»¬æ˜¯æ— æ³•åœ¨ä¸»ç¨‹åºä¸­å¯¹å›è°ƒå‡½æ•°å…·æœ‰æ§åˆ¶æƒçš„ã€‚ä¾‹å¦‚ï¼š</li>
</ol>

<pre><code class="language-js">
  ajax('xxxx', function (err, data) {

  })

</code></pre>
<p>å› ä¸ºåœ¨ajaxçš„è°ƒç”¨æ˜¯å‘ç”Ÿåœ¨ç°åœ¨çš„ï¼Œè¿™æ˜¯åœ¨ä¸»ç¨‹åºçš„æ§åˆ¶ä¹‹ä¸‹çš„ï¼Œä½†æ˜¯ajaxçš„å›è°ƒæ˜¯å»¶è¿Ÿçš„ï¼Œå‘ç”Ÿåœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»ï¼Œå¹¶ä¸æ˜¯åœ¨å½“å‰ä¸»ç¨‹åºä¹‹ä¸­ï¼Œè¿™ä¸­æƒ…å†µè¢«ç§°ä½œ<b>æ§åˆ¶åè½¬</b></p>

<ul>
  <li>å›è°ƒä¼šå¯¼è‡´æˆ‘ä»¬çš„ç¨‹åºå‡ºç°è¿‡æ—©è°ƒç”¨ã€‚</li>
</ul>

<pre><code class="language-js">  function pre (cb) {
    if (!a) {
      cb('error');
    }
    ajax('xxxx', function(err, data) {
      cb(err, data)
    })
  }

  var a = 'a'
  pre(function(err, data) {
    a = data
  })
  console.log(a)
</code></pre>
<p>å½“å‡ºç°è¿™ç§ä»£ç çš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„ä»£ç æ‰§è¡Œæ—¶é—´æ˜¯ä¸å¯æ§çš„ï¼Œå¯èƒ½ä¼šå‡ºç°æå‰è°ƒç”¨ã€‚</p>

<ul>
  <li>å¤ªæ™šè°ƒç”¨æˆ–æ ¹æœ¬æ²¡æœ‰è°ƒç”¨</li>
</ul>

<pre><code class="language-js">  function pre (cb) {
    if (a) {
      ajax('xxxx', function(err, data) {
        cb(err, data)
      })
    }
  }
</code></pre>
<p>å½“aä¸å­˜åœ¨æ—¶ï¼Œè°ƒç”¨preå‡½æ•°æ—¶å›è°ƒæ ¹æœ¬å°±æ²¡æœ‰è°ƒç”¨ï¼Œå› ä¸ºä¸»ç¨‹åºå¤±å»äº†å¯¹å›è°ƒçš„æ§åˆ¶æƒã€‚</p>

<ul>
  <li>å¤æ‚çš„å›è°ƒåµŒå¥—, ä¸€è„¸æ‡µé€¼çš„å›è°ƒåœ°ç‹±ã€‚</li>
</ul>

<p>å¾ˆå¤šçš„æ—¶å€™æˆ‘ä»¬ç»å¸¸æœ‰è¿™æ ·çš„åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦æŠŠä¸€ä¸ªå¼‚æ­¥çš„ç»“æœä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¼‚æ­¥ï¼Œä¸‹ä¸€ä¸ªå¼‚æ­¥ç»“æœä¼ ä¸ªä¸‹ä¸€ä¸ªï¼Œå¾ªç¯å¾€å¤ã€‚å¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„ä»£ç æ˜¯ç®€ä»‹çš„ï¼Œâ€œé“¾å¼â€çš„ä¼ é€’ã€‚</p>

<pre><code class="language-js">  let s = '';
  ajax('xxxx1', function(err, data) {
    s = `${s}${data}, `;
    ajax('xxx2', function(err, data) {
      s = `${s}${data}, `;
      ajax('xxx3', function(err, data) {
        s = `${s}${data}, `;
        ajax('xxx4', function(err, data) {
          s = `${s}${data}, `;
        })
      })
    })
  })
</code></pre>

<ul>
  <li>ç«æ€æ˜¯ä¸€ç»„å¼‚æ­¥æ“ä½œï¼Œå…¶ä¸­ä¸€ä¸ªå®Œæˆäº†ï¼Œ è¿™ç»„å¼‚æ­¥æ“ä½œä¾¿ç®—æ˜¯æ•´ä½“å®Œæˆäº†ã€‚</li>
</ul>

<pre><code class="language-js">
  let flag = true

  function cbFoo () {
    if(flag) {
      let x = 'foo'
      log(x)
      flag = false
    }
  }

  function cbBar () {
    if(flag) {
      let x = 'bar'
      log(x)
      flag = false
    }
  }
  
  function log (x) {
    console.log(x);
  }

  ajax('xxx1', cbFoo)
  ajax('xxx1', cbBar)


</code></pre>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªflagï¼Œ è®¾å®ƒçš„åˆå§‹å€¼ä¸ºtrue, è¿™æ—¶å€™fooæˆ–è€…baråœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œ æ˜¯å¯ä»¥è¿›å…¥ifå†…éƒ¨çš„ä»£ç å—å¹¶ä¸”æ‰§è¡Œbazå‡½æ•°çš„ï¼Œ ä½†åœ¨ifå†…éƒ¨çš„ä»£ç å—ç»“æŸçš„æ—¶å€™ï¼Œ æˆ‘ä»¬æŠŠflagçš„å€¼ç½®ä¸ºfalse,è¿™ä¸ªæ—¶å€™ä¸‹ä¸€ä¸ªå‡½æ•°å°±æ— æ³•è¿›å…¥ä»£ç å—æ‰§è¡Œäº†ï¼Œ è¿™å°±æ˜¯å›è°ƒå¯¹äºç«æ€çš„å¤„ç†</p>

<p>æ€»ç»“ï¼š
è¿‡å¤šçš„ä½¿ç”¨å›è°ƒå‡½æ•°ï¼Œä¼šå¯¼è‡´æˆ‘ä»¬å†™å‡ºä¸€äº›æ— æ³•ç»´æŠ¤çš„ä»£ç ï¼Œåœ¨ä¸€ç«¯æ—¶é—´ä¹‹åï¼Œæˆ‘ä»¬éƒ½ä¸çŸ¥é“è‡ªå·±å†™çš„ä»£ç æ˜¯å•¥ã€‚</p>

<h2 id="ä»€ä¹ˆæ˜¯promise">ä»€ä¹ˆæ˜¯promiseï¼Ÿ</h2>

<p>1.é¦–å…ˆPromiseæ˜¯ä¸€ä¸ªå¯ä»¥åŒ…å«å¼‚æ­¥æ“ä½œçš„å¯¹è±¡</p>

<p>2.å…¶æ¬¡ï¼Œ è¿™ä¸ªå¯¹è±¡æ‹¥æœ‰è‡ªå·±çš„çŠ¶æ€ï¼ˆstateï¼‰ï¼Œå¯ä»¥åˆ†åˆ«ç”¨æ¥è¡¨ç¤ºå¼‚æ­¥æ“ä½œçš„â€œæˆåŠŸâ€, â€œå¤±è´¥â€ï¼Œâ€œæ­£åœ¨è¿›è¡Œä¸­â€ã€‚
å®ƒä»¬æ˜¯ï¼š
  Fulfilledï¼š æˆåŠŸ
  Rejectedï¼šæ‹’ç»
  Pendingï¼š è¿›è¡Œä¸­</p>

<p>3.é‚£æ€ä¹ˆæ§åˆ¶è¿™ä¸‰ä¸ªçŠ¶æ€çš„æ”¹å˜å‘¢ï¼Ÿ
å½“new ä¸€ä¸ªPromiseå¯¹è±¡çš„æ—¶å€™ï¼Œ æˆ‘ä»¬èƒ½æ¥æ”¶åˆ°ä¸¤ä¸ªæ–¹æ³•å‚æ•°ï¼š resolveå’Œreject, å½“è°ƒç”¨ resolveæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæŠŠPromiseå¯¹è±¡çš„çŠ¶æ€ä»Pendingå˜ä¸ºFulfilledï¼ˆè¡¨ç¤ºå¼‚æ­¥æ“ä½œæˆåŠŸäº†ï¼‰ï¼Œå½“è°ƒç”¨ rejectæ–¹æ³•çš„æ—¶å€™ï¼Œ ä¼šæŠŠPromiseå¯¹è±¡çš„çŠ¶æ€ä»Pendingå˜ä¸ºRejectedï¼Œè¡¨ç¤ºå¼‚æ­¥æ“ä½œå¤±è´¥äº†ï¼Œ è€Œå¦‚æœè¿™ä¸¤ä¸ªå‡½æ•°æ²¡æœ‰è°ƒç”¨ï¼Œåˆ™Promiseå¯¹è±¡çš„çŠ¶æ€ä¸€ç›´æ˜¯Pendingï¼ˆè¡¨ç¤ºå¼‚æ­¥æ“ä½œæ­£åœ¨è¿›è¡Œï¼‰</p>

<h2 id="promiseæ˜¯å¦‚ä½•å¸®æˆ‘ä»¬è§£å†³å›è°ƒçš„é—®é¢˜çš„å‘¢">Promiseæ˜¯å¦‚ä½•å¸®æˆ‘ä»¬è§£å†³å›è°ƒçš„é—®é¢˜çš„å‘¢ï¼Ÿ</h2>
<ul>
  <li>è°ƒç”¨è¿‡æ—©é—®é¢˜ï¼Œæˆ‘ä»¬å¶å°”ä¼šå†™å‡ºå¯èƒ½åŒæ­¥ï¼Œå¯èƒ½å¼‚æ­¥çš„å›è°ƒã€‚Promiseåœ¨è°ƒç”¨thenæ–¹æ³•çš„æ—¶å€™,ä¸ç®¡Promiseå†…éƒ¨æ˜¯å¦æ˜¯å¼‚æ­¥çš„ï¼Œè¿˜æ˜¯ä¼šè¢«å½“æˆæ˜¯å¼‚æ­¥çš„è°ƒç”¨</li>
  <li>å›è°ƒè°ƒç”¨æ¬¡æ•°è¿‡å¤šçš„é—®é¢˜ã€‚Promiseå†…éƒ¨å®šä¹‰çš„çŠ¶æ€æ˜¯ä¸å¯é€†è½¬çš„ï¼Œæ‰§è¡Œå®Œä¹‹åthençš„å›è°ƒï¼Œresolveæˆ–è€…rejectä¹‹åï¼ŒçŠ¶æ€å°±è¢«æ”¹å˜äº†</li>
  <li>å›è°ƒåœ°ç‹±é—®é¢˜ã€‚Promiseé“¾å¼è°ƒç”¨ä½¿æˆ‘ä»¬èƒ½å¤Ÿæ›´åŠ ä¼˜é›…çš„å¤„ç†å¤æ‚çš„åº”ç”¨åœºæ™¯ã€‚</li>
</ul>

<pre><code class="language-js"> var result = new Promise((resolve, reject) =&gt; {
   resolve('resolve');
 })
 .then(res =&gt; res)
 .then(res =&gt; res)
 ...
</code></pre>

<h2 id="promise">Promise</h2>

<p>Promise.prototype.then å’Œ Promise.prototype.catchéƒ½è¿”å›Promiseå¯¹è±¡ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°é“¾å¼è°ƒç”¨ã€‚</p>

<p><img src="/assets/images/promises.png" width="100%" height="400px" alt="promiseæµç¨‹å›¾" align="center" /></p>
<h3 id="æ–¹æ³•">æ–¹æ³•</h3>
<ul>
  <li>
    <p>Promise.all(iterable)
è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Promise, è¯¥promiseå¯¹è±¡åœ¨iterableå‚æ•°å¯¹è±¡é‡Œæ‰€æœ‰çš„promiseå¯¹è±¡éƒ½æˆåŠŸçš„æ—¶å€™æ‰ä¼šè§¦å‘æˆåŠŸï¼Œä¸€æ—¦æœ‰ä»»ä½•ä¸€ä¸ªiterableé‡Œé¢çš„promiseå¯¹è±¡å¤±è´¥åˆ™ç«‹å³è§¦å‘è¯¥promiseå¯¹è±¡çš„å¤±è´¥ã€‚
è¿™ä¸ªæ–°çš„promiseå¯¹è±¡åœ¨è§¦å‘æˆåŠŸçŠ¶æ€ä»¥åï¼Œä¼šæŠŠä¸€ä¸ªåŒ…å«iterableé‡Œæ‰€æœ‰promiseè¿”å›å€¼çš„æ•°ç»„ä½œä¸ºæˆåŠŸå›è°ƒçš„è¿”å›å€¼ï¼Œé¡ºåºè·Ÿiterableçš„é¡ºåºä¿æŒä¸€è‡´ï¼›</p>
  </li>
  <li>
    <p>Promise.race(iterable)
å½“iterableå‚æ•°é‡Œçš„ä»»æ„ä¸€ä¸ªå­promiseè¢«æˆåŠŸæˆ–å¤±è´¥åï¼Œçˆ¶promiseé©¬ä¸Šä¹Ÿä¼šç”¨å­promiseçš„æˆåŠŸè¿”å›å€¼æˆ–å¤±è´¥è¯¦æƒ…ä½œä¸ºå‚æ•°è°ƒç”¨çˆ¶promiseç»‘å®šçš„ç›¸åº”å¥æŸ„ï¼Œå¹¶è¿”å›è¯¥promiseå¯¹è±¡ã€‚</p>
  </li>
  <li>
    <p>Promise.reject(reason)
è¿”å›ä¸€ä¸ªçŠ¶æ€ä¸ºå¤±è´¥çš„Promiseå¯¹è±¡ï¼Œå¹¶å°†ç»™å®šçš„å¤±è´¥ä¿¡æ¯ä¼ é€’ç»™å¯¹åº”çš„å¤„ç†æ–¹æ³•</p>
  </li>
  <li>
    <p>Promise.resolve(value)
è¿”å›ä¸€ä¸ªçŠ¶æ€ç”±ç»™å®švalueå†³å®šçš„Promiseå¯¹è±¡ã€‚å¦‚æœè¯¥å€¼æ˜¯thenable(å³ï¼Œå¸¦æœ‰thenæ–¹æ³•çš„å¯¹è±¡)ï¼Œè¿”å›çš„Promiseå¯¹è±¡çš„æœ€ç»ˆçŠ¶æ€ç”±thenæ–¹æ³•æ‰§è¡Œå†³å®šï¼›å¦åˆ™çš„è¯(è¯¥valueä¸ºç©ºï¼ŒåŸºæœ¬ç±»å‹æˆ–è€…ä¸å¸¦thenæ–¹æ³•çš„å¯¹è±¡),è¿”å›çš„Promiseå¯¹è±¡çŠ¶æ€ä¸ºfulfilledï¼Œå¹¶ä¸”å°†è¯¥valueä¼ é€’ç»™å¯¹åº”çš„thenæ–¹æ³•ã€‚</p>
  </li>
</ul>

<h3 id="åŸå‹">åŸå‹</h3>

<ul>
  <li>
    <p>Promise.prototype.catch(onRejected)
æ·»åŠ ä¸€ä¸ªæ‹’ç»(rejection) å›è°ƒåˆ°å½“å‰ promise, è¿”å›ä¸€ä¸ªæ–°çš„promiseã€‚å½“è¿™ä¸ªå›è°ƒå‡½æ•°è¢«è°ƒç”¨ï¼Œæ–° promise å°†ä»¥å®ƒçš„è¿”å›å€¼æ¥resolveï¼Œå¦åˆ™å¦‚æœå½“å‰promise è¿›å…¥fulfilledçŠ¶æ€ï¼Œåˆ™ä»¥å½“å‰promiseçš„å®Œæˆç»“æœä½œä¸ºæ–°promiseçš„å®Œæˆç»“æœ.</p>
  </li>
  <li>
    <p>Promise.prototype.then(onFulfilled, onRejected)
æ·»åŠ è§£å†³(fulfillment)å’Œæ‹’ç»(rejection)å›è°ƒåˆ°å½“å‰ promise, è¿”å›ä¸€ä¸ªæ–°çš„ promise, å°†ä»¥å›è°ƒçš„è¿”å›å€¼æ¥resolve.</p>
  </li>
  <li>
    <p>Promise.prototype.finally(onFinally)
æ·»åŠ ä¸€ä¸ªäº‹ä»¶å¤„ç†å›è°ƒäºå½“å‰promiseå¯¹è±¡ï¼Œå¹¶ä¸”åœ¨åŸpromiseå¯¹è±¡è§£æå®Œæ¯•åï¼Œæ— è®ºæœ€ç»ˆç»“æœæ€æ ·ï¼Œéƒ½ä¼šæ‰§è¡Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„promiseå¯¹è±¡ã€‚</p>

    <p>ä»¥é¡µé¢loadingæ•ˆæœä¸ºä¾‹ï¼š</p>

    <pre><code class="language-js">let loading = true, data = undefined;
fetch('xxxxxxxx')
.then((res) =&gt; {
  data = res.data
})
.catch(error =&gt; {
  console.log(error)
})
.finally(() =&gt; {
  loading = false;
})
</code></pre>
  </li>
</ul>

<h2 id="å¦‚ä½•æ‰‹åŠ¨å®ç°ä¸€ä¸ªç®€å•çš„promise">å¦‚ä½•æ‰‹åŠ¨å®ç°ä¸€ä¸ªç®€å•çš„Promise</h2>

<p>åœ¨å­¦ä¹ å®ŒPromiseåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†é€šè¿‡å®è·µå»å®ç°ä¸€ä¸ªä»…ä»¥é“¾å¼è°ƒç”¨ç®€å•çš„promiseã€‚
æˆ‘ä»¬ä½¿ç”¨Promiseæ˜¯é€šè¿‡æ„é€ å‡½æ•°åˆ›é€ çš„ï¼Œpromiseå›è°ƒæ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œå¹¶ä¸”å›è°ƒå¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚åœ¨resolverä¸­å›ºå®šåŒ–ä¸¤ä¸ªå›è°ƒï¼Œonfilled, onrejectedã€‚å®šä¹‰ç§æœ‰çŠ¶æ€å±æ€§
é‚£æˆ‘ä»¬å…ˆç®€å•å®šä¹‰ä¸€ä¸ªPromiseå¯¹è±¡ã€‚</p>

<pre><code class="language-js">
const State = {
  pending: "pending",
  resolving: "resolving",
  rejecting: "rejecting",
  resolved: "resolved",
  rejected: "rejected"
}

class Promise {
  constructor(resolver) {
    this.promiseStatus = State.pending;
    this.promiseData = "";
    this.funcFilled = undefined;
    this.funcRejected = undefined;
    if (typeof resolver === "function" &amp;&amp; resolver !== undefined) {
      resolver()
    }
  }
  resolve (value) {
    if (this.promiseStatus === State.resolving) {
      this.
    }
  }
  reject (reason) {

  }
}

</code></pre>

<h2 id="å­¦ä¹ è¿æ¥">å­¦ä¹ è¿æ¥</h2>
<p><a href="https://www.cnblogs.com/penghuwan/p/7451409.html">csdn</a>
<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise">mdn</a></p>
:ET